<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Click the biggest number!</title>
</head>

<style>
    @font-face {
        font-family: 'Main';
        src: url('fonts/orbitron-bold-webfont.woff') format('woff');
    }

    body {
        font-family: 'Main';
        font-size: 100%;
    }

    h1 {
        font-size: 4em;
    }

    .page {
        text-align: center;
        width: 800px;
        margin: auto;
    }

    .flex {
        display: flex;
        justify-content: space-evenly;
    }

    .between {
        justify-content: space-between;
    }

    .box {
        width: 200px;
        height: 200px;
        border: 3px dashed;
        border-radius: 100px;
        font-size: 3em;
    }

    .center {
        align-items: center;
    }

    .box:hover {
        border-style: solid;
        cursor: pointer;
        background-color: cadetblue;
    }

    .scoreboard {
        display: inline-block;
        margin-top: 2em;
        border: 2px solid;
        border-radius: 20px;
        width: 800px;
        font-size: 2em;
        padding: 0.5em;
    }
</style>

<body>
    <div class="page">
        <h1>Hit the biggest number!</h1>
        <div class="flex">
            <div class="box flex center" data-number="1">1</div>
            <div class="box flex center" data-number="3">Start</div>
            <div class="box flex center" data-number="2">2</div>
        </div>
        <div data-game-state="MAIN_MENU"><button>Hello</button></div>
        <div class="scoreboard">
            <div class="flex between">
                <span id="score-correct">Correct: 0</span>
                <span id="score-mistakes">Mistakes: 0</span>
                <span id="score-time-bonus">Time-Bonus: 0</span>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    let boxes;
    let score = {
        correct: 0,
        mistakes: 0,
        timeBonus: 0
    };
    let timeLeft = 0;

    const gameStates = {
        MAIN_MENU: "MAIN_MENU",
        STANDARD: "STANDARD",
        MULTIPLICATION_TABLES_BASIC: "MULTIPLICATION_TABLES_BASIC"
    }

    const _game = {
        state: gameStates.MAIN_MENU
    }

    const gameStateMachine = {
        set: function (target, prop, value, receiver) {
            if (prop === "state") {
                if (!gameStates.hasOwnProperty(value)) {
                    throw 'Invalid game state';
                }
                document.querySelectorAll("[data-game-state]").forEach(e => {
                    if (e.getAttribute("data-game-state") === value) {
                        e.style.visibility = "visible";
                    } else {
                        e.style.visibility = "hidden";
                    }
                });
            }
            return Reflect.set(...arguments);
        }
    }

    const game = new Proxy(_game, gameStateMachine);

    setup(gameStates.MULTIPLICATION_TABLES_BASIC);

    function setup(gameState) {
        game.state = gameState;
        boxes = document.querySelectorAll('.box');
        boxes.forEach(target => target.addEventListener('click', boxClicked));
        setInterval(updateTimeLeft, 1000);
    }

    function updateTimeLeft(seconds) {
        if (seconds) {
            timeLeft = seconds;
        } else {
            timeLeft = Math.max(timeLeft - 1, 0);
        }
        document.getElementById('score-time-bonus').innerHTML = `Time-Bonus: ${timeLeft}`;
    }

    function boxClicked(event) {
        let clickedBox = event.currentTarget;
        let guessedNumber = clickedBox.getAttribute("data-number");
        let biggestNumber = Math.max(...[...boxes].map(b => b.getAttribute("data-number")));

        if (guessedNumber == biggestNumber) {
            score.correct++;
            score.correct += timeLeft;
            document.getElementById('score-correct').innerHTML = `Correct: ${score.correct}`;
        }
        else {
            score.mistakes++;
            document.getElementById('score-mistakes').innerHTML = `Mistakes: ${score.mistakes}`;
        }

        assignRandomNumbers(boxes);
        updateTimeLeft(5);
    }

    function assignRandomNumbers(boxes) {
        switch (game.state) {
            case gameStates.STANDARD:
                boxes.forEach(b => createStandardTask(b));
                break;
            case gameStates.MULTIPLICATION_TABLES_BASIC:
                let task1, task2, task3;
                task1 = createMultiplicationTask(2, 7);
                
                // task2 = createModifiedMultiplicationTask(task1);
                do {
                    task2 = createModifiedMultiplicationTask(task1);
                } while (task2[0] * task2[1] == task1[0] * task1[1]);
                
                // task3 = createModifiedMultiplicationTask(task2);
                do {
                    task3 = createModifiedMultiplicationTask(task1);
                } while (task3[0] * task3[1] == task1[0] * task1[1]
                        || task3[0] * task3[1] == task2[0] * task2[1]);
                

                let tasks = [
                    task1,
                    task2,
                    task3
                ].sort(() => 0.5 - Math.random());

                for (const box of boxes) {
                    let [fac1, fac2] = tasks.pop();
                    switch (getRandomInt(3)) {
                        case 0:
                        case 1:
                            box.innerHTML = `<div>${fac1} x ${fac2}</div>`;
                            box.setAttribute("data-number", fac1 * fac2);
                            break;
                        case 2:
                            box.innerHTML = `<div>${fac1 * fac2}</div>`;
                            box.setAttribute("data-number", fac1 * fac2);
                            break;
                    }
                }
                break;
            default:
                break;
        }
    }

    function createStandardTask(box) {
        switch (getRandomInt(3)) {
            case 0:
                let rnd = getRandomInt(10);
                box.innerHTML = `<div>${rnd}</div>`;
                box.setAttribute("data-number", rnd);
                break;
            case 1:
                let add1 = getRandomInt(10);
                let add2 = getRandomInt(10 - add1);
                box.innerHTML = `<div>${add1} + ${add2}</div>`;
                box.setAttribute("data-number", add1 + add2);
                break;
            case 2:
                let min = 5 + getRandomInt(5);
                let sub = getRandomInt(min);
                let diff = min - sub;
                box.innerHTML = `<div>${min} - ${sub}</div>`;
                box.setAttribute("data-number", diff);
            default:
                break;
        }
    }

    function createMultiplicationTask(base = 0, modifier = 11) {
        let fac1 = base + getRandomInt(modifier);
        let fac2 = base + getRandomInt(modifier);
        return [fac1, fac2];
    }

    function createModifiedMultiplicationTask(base, modifier = 2) {
        let [fac1, fac2] = [...base].sort(() => 0.5 - Math.random());
        fac1 = clamp(fac1 + getModifier(modifier), 0, 10);
        fac2 = clamp(fac2 + getModifier(modifier), 0, 10);
        return [fac1, fac2];
    }

    function clamp(value, min, max) {
        return Math.max(Math.min(max, value), min);
    }

    function getModifier(delta) {
        let mod = Math.floor(Math.random() * (delta * 2 + 1)) - delta;
        return mod;
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

</script>